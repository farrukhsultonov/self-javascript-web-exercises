<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HTTP Requests</title>
</head>
<body>
<h4>Books</h4>
<p id="my-books"></p>

<script>
    "use strict";

    // explain how the web works: requests and responses
    // mention how long it takes to get a response (LATENCY)
    // examples https://speed.cloudflare.com/
    // and https://testmy.net/latency?testALL=1
    // https://developer.mozilla.org/en-US/docs/Web/Performance/Understanding_latency
    // compare that to general acceptable page load time: 100ms

    // explain common types of requests (also called HTTP Methods)
    // GET POST PUT PATCH DELETE

    // introduce the fetch api
    // mention fetch's default response type is GET

    // show basic fetch
    fetch("https://pokeapi.co/api/v2/pokemon/charmander");
    // what does fetch return??? a pokemon character?

    // save it to a variable and log it
    const something = fetch("https://pokeapi.co/api/v2/pokemon/charmander");
    console.log(something);

    // explain asynchronous and Promises

    // use the .then() method of the promise
    // and log the response
    const pokePromise = fetch("https://pokeapi.co/api/v2/pokemon/charmander");
    pokePromise.then(function(response) {
        console.log(response);
    });
    // explain the callback function above!


    // now show asynchronous behavior at work
    console.log("Before the fetch");
    const pokePromise2 = fetch("https://pokeapi.co/api/v2/pokemon/charmander");
    pokePromise2.then(function(response) {
        console.log("Got a response!");
        console.log(response);
    });
    console.log("After the fetch");

    // explain ok and status (response status codes)
    // show http response codes
    // https://developer.mozilla.org/en-US/docs/Web/HTTP/Status

    // point out the unusable body

    // use ok and status
    const pokePromise3 = fetch("https://pokeapi.co/api/v2/pokemon/charmander");
    pokePromise3.then(function(response) {
        if(!response.ok) {
            console.log("ERROR!");
            console.log(response.statusText); // this may not print anything depending on the status code
        } else {
            console.log("Success!");
            console.log(response);
        }
    });

    // don't have to use an intermediary variable
    fetch("https://pokeapi.co/api/v2/pokemon/charmander")
        .then(function(response) {
            console.log(response);
        });

    // now let's use the JSON body that is returned in the response
    // the handy json() function
    fetch("https://pokeapi.co/api/v2/pokemon/charmander")
        .then(function(response) {
            console.log(response.json());
        });

    // WHAT?!? another promise!?!
    // ok, can we just use .json().then()?
    // sure. we call that callback hell, or the pyramid of doom
    fetch("https://pokeapi.co/api/v2/pokemon/charmander")
        .then(function(response) {
            response.json()
                .then(function(data) {
                    console.log("yay I finally have some data. :|");
                    console.log(data);
                })
        });

    // instead of callback hell, we can RETURN THE .json() PROMISE and keep its .then() inline with the other .then()
    // this improves its readability
    fetch("https://pokeapi.co/api/v2/pokemon/charmander")
        .then(function(response) {
            return response.json();
        }).then(function(data) {
        console.log("yay I finally have some data. :|");
        console.log(data);
    });

    // here is where I will admit arrow functions and named functions clean it up nicely
    function usePokemon(pokemon) {
        console.log("yay I finally have some data. :|");
        console.log(pokemon);
    }

    fetch("https://pokeapi.co/api/v2/pokemon/charmander")
        .then(response => response.json())
        .then(data => usePokemon(data));

    // catch and finally
    function handleError(error) {
        console.log("ERROR!");
        console.log(error.message);
    }

    function cleanUp() {
        console.log("stop loading animation");
    }

    console.log("start loading animation");
    fetch("https://www.google.com")
        .then(response => response.json())
        .then(data => usePokemon(data))
        .catch(error => handleError(error))
        .finally(cleanUp);

    // point at start and stop of loading animation
    // why is finally a good place to stop the loading animation?

    // change url to www.google.com
    // explain CORS error BRIEFLY! only need to be aware of it for now
    // https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS

    // show POST options in textbook. point at Content-Type and body for POST/PUT/PATCH

    // make options for a GET request
    const options = {
        method: "GET",
        headers: { "Authorization": "my secret token!" }
    }
    fetch("https://animechan.xyz/api/random", options)
        .then(response => response.json())
        .then(data => usePokemon(data))

    // show github public apis
    // https://github.com/public-apis/public-apis

    // try this with anime chan
    // I ran into CORS issues once with anime chan. but seems ok now


    // lastly, show how you can use fetch to read a data file
    // and display its contents in an HTML element

    // read the book data and point out HOW FAST reading data locally is compared to over internet
    function processBooks(books) {
        for (let i = 0; i < books.length; i++) {
            document.querySelector("#my-books").innerText += books[i].title + "\n";
        }
    }

    fetch("data/books.json")
        .then(response => response.json())
        .then(books => processBooks(books));


</script>
</body>
</html>